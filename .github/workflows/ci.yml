name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PHP_VERSION: '8.4'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # PARALLEL JOBS - All run simultaneously
  # ═══════════════════════════════════════════════════════════════════════════

  lint:
    name: Lint (Pint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run Pint
        run: ./vendor/bin/pint --test

  analyse:
    name: Static Analysis (PHPStan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run PHPStan
        run: ./vendor/bin/phpstan analyse app --memory-limit=2G --level=5
        continue-on-error: true  # TODO: Fix PHPDoc annotations on models

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Run security audit
        run: composer audit

  test:
    name: Tests (Pest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_sqlite, bcmath
          tools: composer:v2
          coverage: xdebug

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Prepare Laravel
        run: |
          cp .env.example .env
          php artisan key:generate --ansi
          touch database/database.sqlite
          php artisan migrate --force --ansi

      - name: Run tests
        run: php artisan test --coverage-clover=coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ═══════════════════════════════════════════════════════════════════════════
  # BUILD - Only on main branch after all checks pass
  # ═══════════════════════════════════════════════════════════════════════════

  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: [lint, analyse, security, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo, pdo_sqlite, bcmath, gd
          tools: composer:v2
          coverage: none

      - name: Install production dependencies
        run: composer install --optimize-autoloader --no-dev --no-interaction

      - name: Prepare Laravel
        run: |
          cp .env.example .env
          php artisan key:generate --ansi
          touch database/database.sqlite
          php artisan migrate --force --ansi
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache
          php artisan optimize

      - name: Create artifact
        run: |
          mkdir -p artifact
          rsync -av --exclude='artifact' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='phpunit.xml' \
            . artifact/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: laravel-app-${{ github.sha }}
          path: artifact/
          retention-days: 7
